# 计量资料的统计描述

```{r}
#| echo: false

source("_common.R")
```

## 安装包

```{r}
#| message: false
library(haven)
library(tidyverse)
library(kableExtra)
library(broom)
library(showtext)                                             # <1>
```

1.  showtext包允许在绘图时使用系统中任意的TrueType或OpenType字体

## 频数分布

### 频数分布表

```{r}
adsl <- read_sas("data-adam/adsl.sas7bdat")
BMI_BL <- adsl |> 
  select(BMIBL)
```

**例2-1** 某医院用随机抽样方法检查了138名正常成年女性的红细胞数($\times10^{12}/L$)，其测量结果如下，试编制频数分布表。

------------------------------------------------------------------------

```{r}
adsl <- read_sas("data-adam/adsl.sas7bdat")
bmi <- adsl |> 
  select(BMIBL, SEX) |> 
  filter(SEX == "F") |> 
  select(BMIBL) |> 
  unlist(use.names = F)
cat(bmi) 
```

------------------------------------------------------------------------

若rbc为138名正常成年女性的红细胞数的测量值，求rbc的最小值、最大值和极差：

```{r}
bmi |> 
  is.na() |> 
  sum()
```

bmi 中有1个缺失值，做删除处理或进行缺失值填充：

```{r}
bmi_clean <- na.omit(bmi)
bmi_filled <- if_else(is.na(bmi), mean(bmi, na.rm = T), bmi) |> 
  round(digits = 1)
```

```{r}
bmi <- bmi_filled

range(bmi)                                    # <1>

range_bmi <- range(bmi) |>                               
  diff() |>                                   # <2>
  print()

min_bmi <- min(bmi)
min_bmi

max_bmi <- max(bmi)
max_bmi 

range_bmi <- max_bmi - min_bmi
range_bmi
```

1.  `range()`返回包含最小值和最大值的向量
2.  利用管道操作符和`diff()`计算极差

组段数通常取10\~15组，这里取12，计算组距 (保留两位小数)：

```{r}
bin_width <- round(range_bmi/12, 2)
bin_width
```

根据组距写出组段的上下限：

```{r}
breaks <- seq(from = min_bmi, to = max_bmi, by = bin_width)
breaks |> 
  t() |> 
  kbl() |> 
  kable_classic()
```

使用`cut()`函数将数据分到指定的组段，并根据它们落在哪个区间对变量值进行编码；此函数可判断上述分组方法是否合适： 例如若 `seq()` 的参数 f`rom = min_bmi`，`to = max_bmi`，则有变量值的编码区间为 `NA`：

```{r}
cut(bmi, breaks = breaks, right = F) |> 
  str_c() |> 
  c(rep(" ", ceiling(length(bmi) / 8) * 8 - length(bmi))) |>   # <1>
  matrix(ncol = 8, byrow = T) |> 
  kbl() |> 
  kable_classic()
```

1.  每行输出8个区间，输出元素个数是8的整数倍，不足的用空字符补足。

此时可调整参数 `from` 或 `to`的值，直到编码区间没有 `NA` 为止；为避免麻烦，直接减（加）上组距。

```{r}
breaks <- seq(from = min_bmi - bin_width, to = max_bmi + bin_width, by = bin_width)

cut(bmi, breaks = breaks, right = F) |> 
  str_c() |> 
  c(rep(" ", ceiling(length(bmi) / 8) * 8 - length(bmi))) |>
  matrix(nrow = 18, ncol = 8, byrow = T) |> 
  kbl() |> 
  kable_classic()
```

生成频数分布表：

```{r}
#| label: tbl-freq-distribute
#| tbl-cap: 138名正常成年女性的红细胞数频数分布

DescTools::Freq(bmi, breaks = breaks) |> 
  kbl(digits = 3, align = "c") |>
  kable_classic(full_width = F) |> 
  row_spec(0, bold = T)
```

### 频数分布图

```{r}
#| label: fig-freq-distribute
#| fig-cap: 138名正常成年女性的红细胞数频数分布

hist(
  x              = rbc, 
  breaks         = breaks, 
  right          = T, 
  col            = "light gray", 
  include.lowest = T,
  main           = " ",
  xlab           = "红细胞数",
  ylab           = "频数",
  xlim           = c(3, 5.8),
  ylim           = c(0, 35)
)
```

## 集中趋势的描述

### 算术均数

**例2-2** 计算例2-1某医院138名正常成年女性的红细胞数的均数。

```{r}
mean(BMI_BL, na.rm = T) |> 
  round(digits = 2)
```

### 几何均数

**例2-3** 69例类风湿关节炎（RA）患者血清EBV-VCA-lgG抗体滴度测量值如下，求其平均抗体滴度。

```{r}
#| echo: false
#| results: asis

serum_antibody_titer <- haven::read_dta("datasets/例02-05.dta") |> 
  unlist(use.names = F)
cat(serum_antibody_titer)
```

设serum_antibody_titer为患者血清抗体滴度变量，则几何均数为：

```{r}
serum_antibody_titer |> 
  DescTools::Gmean() |> 
  round(digits = 1)
```

### 中位数与四分位数

计算例2-1某医院138名正常成年女性的红细胞数的中位数和四分位数：

```{r}
median(rbc)
quantile(rbc, probs = c(0.25, 0.5, 0.75)) |> 
  round(digits = 2)
```

## 离散趋势的描述

以例2-1某医院138名正常成年女性的红细胞数为例，计算描述离散趋势的统计指标：

### 极差

```{r}
range(rbc) |> 
  diff()
```

### 四分位数间距

```{r}
IQR(rbc) |> 
  round(digits = 2)
```

### 方差和标准差

```{r}
var(rbc)
sd(rbc)
```

### 变异系数

```{r}
sd(rbc) / mean(rbc) * 100
```

## 医学参考值范围

以例2-1某医院138名正常成年女性的红细胞数为例，确定其医学参考值范围：

```{r}
ref_range <- quantile(rbc, probs = c(0.025, 0.975)) |> 
  round(digits = 3) |> 
  print()
```

由上可知，正常成年女性红细胞数的95%医学参考值范围为: `r paste0("(", ref_range[1], ", ", ref_range[2], ")")`

```{r}
install.packages("DescTools")
```
